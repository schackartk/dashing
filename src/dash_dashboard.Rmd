---
title: "Dashing"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    theme:
      bootswatch: lux
---

```{=html}
<style>
.navbar {
  margin: 0;
  padding: 0;
  height: 10;
  display: block;
  position: fixed;
}
</style>
```

```{r setup, include=FALSE}
library(dplyr)
library(flexdashboard)
library(forcats)
library(ggplot2)
library(glue)
library(kableExtra)
library(lubridate)
library(magrittr)
library(readxl)
library(scales)
library(stringr)
library(tibble)
library(tidyr)

source("config.R")
source("helpers.R")
source("style.R")
```

```{r load_data, include=FALSE}
load(paste0("../",data_paths['wrangled_data']))
```

# Totals {data-icon="glyphicon-globe"}

## Column {data-width="150"}

### Deliveries

```{r total_deliveries}
valueBox(value = totals['deliveries'],
         caption = "Deliveries",
         icon = "fa-car")
```

### Miles

```{r total_miles}
valueBox(value = totals['miles'],
         caption = "Miles",
         color = "secondary",
         icon = "fa-map")
```

### Restaurants

```{r total_places}
valueBox(value = totals['places'],
         caption = "Merchants",
         color = "secondary",
         icon = "fa-map-marked-alt")
```

### Dashes

```{r total_dashes}
valueBox(value = totals['dashes'],
         caption = "Dashes",
         color = "secondary",
         icon = "fa-road")
```

## Column {data-width="150"}

### Earnings

```{r total_earnings}
valueBox(value = totals['earnings'] %>% as_dollar(),
         caption = "Earnings",
         icon = "fa-money-bill-wave-alt")
```

### Tips

```{r total_tips}
tips_pct <- 100 * round(totals['tips'] / totals['earnings'], digits = 2)
valueBox(value = totals['tips'] %>% as_dollar(),
         caption = str_glue("Tips ({tips_pct}%)"),
         color = "secondary",
         icon = "fa-hand-holding-usd")
```

### Base Pay

```{r total_base}
base_pct <- 100 * round(totals['base'] / totals['earnings'], digits = 2)
valueBox(value = totals['base'] %>% as_dollar(),
         caption = str_glue("Base Pay ({base_pct}%)"),
         color = "secondary",
         icon = "fa-money-check-alt")
```

### Peak Pay

```{r total_peak}
peak_pct <- 100 * round(totals['peak'] / totals['earnings'], digits = 2)
valueBox(value = totals['peak'] %>% as_dollar(),
         caption = str_glue("Peak (Bonus) Pay ({peak_pct}%)"),
         color = "secondary",
         icon = "fa-coins")
```

## Column {data-width="150"}

### Hours

```{r total_hours}
valueBox(value = totals['time'],
         caption = "Hours",
         icon = "fa-stopwatch")
```

### Active Time

```{r total_active}
active_pct <- 100 * round(totals['active'] / totals['time'],
                    digits = 2)
valueBox(value = paste(round(totals['active'], digits = 2),
                       "hr"),
         caption = str_glue("Active Time ({active_pct}%)"),
         color = "secondary",
         icon = "fa-walking")
```

### Idle Time

```{r total_idle}
idle_pct <- 100 * round(totals['idle'] / totals['time'], digits = 2)
valueBox(value = paste(round(totals['idle'], digits = 2),
                       "hr"),
         caption = str_glue("Time Between Orders ({idle_pct}%)"),
         color = "secondary",
         icon = "fa-blind")
```

### Dashing Duration

```{r dasher_duration}
dash_dur <- interval(min(df_dashes$date),
                        max(df_dashes$date))

dash_months <- dash_dur %/% months(1)

dash_weeks <- dash_dur %% months(1) %/% weeks(1)

valueBox(value = str_glue("{dash_months} mo, {dash_weeks} wk"),
         caption = str_glue("Time as a Dasher"),
         color = "secondary",
         icon = "fa-calendar-alt")
```


# Statistics {data-icon="fa-calculator"}

## Column {data-width="300"}

### Hourly

```{r avg_hourly}
avg_hourly <- totals['earnings'] / totals['time']
avg_hourly_str <- avg_hourly %>% round(digits = 2) %>% as_dollar()
valueBox(value = str_glue("{avg_hourly_str}/hour"),
         caption = "Average Hourly Rate",
         color = "secondary")
```

### By Delivery

```{r avg_delivery}
avg_per_deliv <- totals['earnings'] / totals['deliveries']
avg_per_deliv_str <- avg_per_deliv %>% round(digits = 2) %>% as_dollar
valueBox(value = str_glue("{avg_per_deliv_str}/delivery"),
         caption = "Average Earnings per Delivery",
         color = "secondary")
```

### By Mile

```{r avg_milely}
avg_per_mile <- totals['earnings'] / totals['miles']
avg_per_mile_str <- avg_per_mile %>% round(digits = 2) %>% as_dollar
valueBox(value = str_glue("{avg_per_mile_str}/mile"),
         caption = "Average Earnings per Mile",
         color = "secondary")
```

### Deliveries per Dash

```{r avg_deliveries}
avg_per_dash <- (totals['deliveries'] / totals['dashes']) %>% 
  round(digits = 2)
valueBox(value = str_glue("{avg_per_dash} deliveries"),
         caption = "Average Deliveries per Dash",
         color = "secondary")

```

## Column {.tabset}

### Earnings Over Time

```{r earn_over_time, cache=TRUE}
df_earnings <- full_join(df_dashes, df_deliveries, by = c("date", "day")) %>% 
  select(date, per_hour, total) %>% 
  pivot_longer(cols = c(per_hour, total),
               names_to = "series") %>% 
  unique()

df_earnings$date <- as.Date(df_earnings$date)

df_earnings %>% ggplot(aes(x = date, y = value,
                           color = series, alpha = series)) +
  geom_vline(xintercept = as.Date(c("2021-01-01", "2021-03-13")),
             color = "darkgray", linetype = "dashed",
             size = 1, alpha = 0.5) +
  geom_point() +
  scale_color_manual(values = c("black", "gray"),
                     labels = c("Hourly for Dash", "Individual Delivery")) +
  scale_alpha_manual(values = c(1, 0.5),
                     labels = c("Hourly for Dash", "Individual Delivery")) +
  nb_theme +
  theme(legend.position = "bottom") +
  scale_x_date(labels = date_format("%b %Y"), date_breaks = "2 months") +
  scale_y_continuous(labels = dollar_format()) +
  labs(x = "",
       caption = "Approximate stimulus check dates as dashed lines",
       y = "Earnings",
       color = "", alpha = "")
```

### Tips Histogram

```{r tips_histo, cache=TRUE}
avg_tip = mean(df_deliveries$tip)

max_freq <- max(hist(x=df_deliveries$tip,
                     breaks=seq(0, max(df_deliveries$tip), by=0.5),
                     plot=FALSE)$counts)

df_deliveries %>%
  arrange(tip) %>% 
  ggplot(aes(x = tip)) +
  geom_histogram(breaks=seq(0, max(df_deliveries$tip), by=1),
                 fill = "lightgray", color = "gray") +
  geom_vline(xintercept = avg_tip, color = "darkgray",
             linetype = "dashed", size = 1) +
  geom_text(aes(x = avg_tip, y = max_freq), nudge_x = 2.2,
            label = str_glue("Average: ${round(avg_tip,2)}"),
            color = "darkgray") +
  scale_x_continuous(labels = dollar_format()) +
  nb_theme +
  labs(title = "Histogram of Tips",
       x = "Tip Amount",
       y = "Number of Deliveries")
```

### Base Pay Histogram

```{r base_histo, cache=TRUE}
avg_base <-  mean(df_deliveries$base_pay)

max_freq <- max(hist(x=df_deliveries$base_pay,
                     breaks=seq(0, max(df_deliveries$base_pay), by=0.5),
                     plot=FALSE)$counts)

df_deliveries %>%
  arrange(base_pay) %>% 
  ggplot(aes(x = base_pay)) +
  geom_histogram(breaks=seq(min(df_deliveries$base_pay),
                            max(df_deliveries$base_pay),
                            by=0.5),
                 fill = "lightgray", color = "gray") +
  geom_vline(xintercept = avg_base, color = "darkgray",
             linetype = "dashed", size = 1) +
  geom_text(aes(x = avg_base, y = max_freq), nudge_x = 2.2,
            label = str_glue("Average: ${round(avg_base,2)}"),
            color = "darkgray") +
  scale_x_continuous(labels = dollar_format()) +
  nb_theme +
  labs(title = "Histogram of Base Pay",
       x = "Base Pay Amount",
       y = "Number of Deliveries")
```

# Hi-Scores {data-icon="fa-medal"}

## Column {data-width="300"}

### Best Dash Hourly

```{r most_hourly}
most_hourly <- max(df_dashes$per_hour)
most_hourly_date <- df_dashes$date[df_dashes$per_hour == most_hourly]
valueBox(value = paste0(as_dollar(most_hourly),"/hr"),
         caption = glue("Highest Hourly Rate, {most_hourly_date}"),
         color = "secondary")
```

### Highest Tip

```{r best_tip}
highest_tip <- max(df_deliveries$tip)
highest_tip_place <- df_deliveries$place[
  df_deliveries$tip == highest_tip]
valueBox(value = paste(as_dollar(highest_tip), "tip"),
         caption = glue("Highest Tip, from {highest_tip_place}"),
         color = "secondary")
```

### Most deliveries

```{r most_deliveries_dash}
most_deliveries <- max(df_dashes$deliveries)
most_deliveries_date <- df_dashes$date[
  df_dashes$deliveries == most_deliveries]
valueBox(value = paste(most_deliveries, "deliveries"),
         caption = glue("Most Deliveries per Dash, {most_deliveries_date}"),
         color = "secondary")
```

### Longest dash

```{r longest_dash}
longest_dash <- max(df_dashes$total_time)
longest_dash_date <- df_dashes$date[
  df_dashes$total_time == longest_dash]
valueBox(value = paste(longest_dash, "hours"),
         caption = glue("Longest Dash, {longest_dash_date}"),
         color = "secondary")
```

## Column {.tabset}

### Most Deliveries

```{r most_deliveries, cache=TRUE}
places_summary %>%
  slice_max(order_by = count, n = 10) %>% 
  mutate(place = factor(place, levels = rev(place))) %>%
  mutate(place = fct_reorder(place, count)) %>%
  ggplot(aes(x = count, y = place, label = count)) +
  geom_col() +
  geom_label(x = 0.5) +
  nb_theme +
  theme(axis.text.x = element_blank()) +
  labs(title = "Number of Deliveries by Place",
       x = "",
       y = "")
```

### Highest Average Tips

```{r highest_tips, cache=TRUE}
places_summary %>%
  filter(count > 1) %>% 
  slice_max(order_by = mean_tip, n = 10) %>% 
  mutate(place = factor(place, levels = rev(place))) %>%
  mutate(place = fct_reorder(place, mean_tip)) %>%
  ggplot(aes(x = mean_tip, y = place,
             label = sprintf("$%0.2f", round(mean_tip, digits = 2)))) +
  geom_col() +
  geom_label(x = 0.8) +
  nb_theme +
  theme(axis.text.x = element_blank()) +
  labs(title = "Average Tip by Place",
       subtitle = "For places with more than 1 delivery",
       x = "",
       y = "")
```

# Maps {data-icon="fa-map"}

## Column

```{r map, echo=FALSE}
htmltools::tags$iframe(src = "heatmap.html",
                       height=450, width="100%",
                       frameborder="0",
                       id="heatmap")

htmltools::tags$script(htmltools::HTML("iFrameResize({ log: true }, '#heatmap')"))
```

## Column

```{r animated, echo=FALSE, out.height=450, out.width=450}
knitr::include_graphics("animation.gif")
```


# Meta {data-icon="fa-comment"}

## Column

### Dashing Data

Dasher app does not have an API for automating access to your information as a
Dasher!

This means that I had to record and organize my Dasher data myself.

Most data is present in the app, such as the earnings for each delivery.

I recorded the mileage myself, and is necessary for tax purposes anyway.

Here are a few notes on the nature of the data:

* Although I may pick up from many locations, if they are the same chain,
that is all that is recorded. For example, all McDonalds locations are just
recorded as McDonalds.

* All earnings shown here are gross; they are before taxes, gas, and other costs.

For more detailed information on the data I recorded, you can see my GitHub repo
[README.md](https://github.com/schackartk/dashing/tree/main/data).


## Column

### Location Data

Location data is downloaded from [Google Takeout](takeout.google.com/).
All that is needed for this information to be available to you is having
*Location history* by Google Maps allowed on your phone.

I process the data using a small R package I wrote for this purpose called
[takeout](https://github.com/schackartk/takeout). The heatmap shown is made
using Python. I have made a similar heatmap in R, but R's implementation of Leaflet
doesn't seem capable of making it look as nice as Python's. 

The reason the map window is odd is that I am using an iframe to display a
separate html file (from Python), instead of building the map in the R dashboard
file.
